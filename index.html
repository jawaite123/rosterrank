<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#059669">
  <meta name="description" content="Rate and track your softball team's players with detailed scoring metrics">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RosterRank">
  <link rel="manifest" href="/rosterrank/manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23059669' width='180' height='180' rx='40'/><text x='50%' y='50%' font-size='90' fill='white' text-anchor='middle' dominant-baseline='central' font-weight='bold'>âš¾</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23059669' width='180' height='180' rx='40'/><text x='50%' y='50%' font-size='90' fill='white' text-anchor='middle' dominant-baseline='central' font-weight='bold'>âš¾</text></svg>">
  <title>âš¾ RosterRank - Softball Player Ratings</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase configuration - Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyCBRw7vvxAFtx5q5dN0G70Xde_JX7ZqGdQ",
      authDomain: "rosterrank-37d0a.firebaseapp.com",
      projectId: "rosterrank-37d0a",
      storageBucket: "rosterrank-37d0a.firebasestorage.app",
      messagingSenderId: "98560724581",
      appId: "1:98560724581:web:eb451ba3ff560d11da808c"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence().catch((err) => {
      if (err.code === 'failed-precondition') {
        console.log('Multiple tabs open, persistence only enabled in one tab.');
      } else if (err.code === 'unimplemented') {
        console.log('Browser does not support persistence.');
      }
    });
  </script>
  <style>
    /* Custom slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      border: 3px solid currentColor;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    input[type="range"]::-moz-range-thumb {
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      border: 3px solid currentColor;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Lucide React icons as inline SVGs
    const Trash2 = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const Plus = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Download = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Edit2 = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      </svg>
    );

    const Save = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
    );

    const X = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const AlertCircle = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    );

    const Sparkles = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
        <path d="M5 3v4"></path>
        <path d="M19 17v4"></path>
        <path d="M3 5h4"></path>
        <path d="M17 19h4"></path>
      </svg>
    );

    const Cloud = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path>
      </svg>
    );

    const CloudOff = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="m2 2 20 20"></path>
        <path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193"></path>
        <path d="M21.532 16.5A4.5 4.5 0 0 0 17.5 10h-1.79A7.008 7.008 0 0 0 10 5.07"></path>
      </svg>
    );

    const Loader = ({ size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="12" y1="2" x2="12" y2="6"></line>
        <line x1="12" y1="18" x2="12" y2="22"></line>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
        <line x1="2" y1="12" x2="6" y2="12"></line>
        <line x1="18" y1="12" x2="22" y2="12"></line>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
      </svg>
    );

    function SoftballPlayerRater() {
      const [players, setPlayers] = useState([]);
      const [modal, setModal] = useState({ visible: false, title: '', message: '', onAction: null, actionLabel: '' });
      const [updateModal, setUpdateModal] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [appVersion, setAppVersion] = useState(null);
      const [changelog, setChangelog] = useState({});
      const [currentPlayer, setCurrentPlayer] = useState({
        number: '',
        hitting: 5,
        popfly: 5,
        fielding: 5,
        throwing: 5,
        comments: ''
      });
      const [userId, setUserId] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [syncStatus, setSyncStatus] = useState('offline'); // 'synced', 'syncing', 'offline', 'error'
      const [hasMigrated, setHasMigrated] = useState(false); // Track if we've done initial migration

      // Load changelog from external file
      useEffect(() => {
        // Try both paths - production (/rosterrank/) and local (relative)
        const tryFetch = async () => {
          try {
            // Try production path first
            let response = await fetch('/rosterrank/changelog.json');

            if (!response.ok) {
              // Fallback to relative path for local development
              response = await fetch('./changelog.json');
            }

            // Parse JSON regardless of content-type (GitHub Pages may not set it correctly)
            const data = await response.json();
            setAppVersion(data.version);
            setChangelog(data.releases);

            // Check if user has seen this version (only after successful load)
            const lastSeenVersion = localStorage.getItem('lastSeenVersion');
            if (lastSeenVersion !== data.version) {
              // Don't auto-show on first visit, only on updates
              if (lastSeenVersion !== null) {
                setUpdateModal(true);
              }
              localStorage.setItem('lastSeenVersion', data.version);
            }
          } catch (error) {
            console.error('Error loading changelog:', error);
            // Fallback to default version if all fetch attempts fail
            setAppVersion('1.0.0');
            setChangelog({});
          }
        };

        tryFetch();
      }, []);

      // Make setUpdateModal available globally for service worker
      useEffect(() => {
        window.showUpdateModal = () => setUpdateModal(true);
        return () => delete window.showUpdateModal;
      }, []);

      const currentChangelog = changelog[appVersion] || { date: '', changes: [] };

      // Anonymous authentication
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // Sign in anonymously
            try {
              await auth.signInAnonymously();
            } catch (error) {
              console.error('Auth error:', error);
              setSyncStatus('error');
              // Fall back to localStorage
              const saved = localStorage.getItem('softballPlayers');
              if (saved) {
                try {
                  setPlayers(JSON.parse(saved));
                } catch (e) {
                  console.error('Error loading saved data:', e);
                }
              }
              setIsLoading(false);
            }
          }
        });
        return () => unsubscribe();
      }, []);

      // Firestore real-time sync
      useEffect(() => {
        if (!userId) return;

        setSyncStatus('syncing');

        // Set up real-time listener
        const unsubscribe = db.collection('users').doc(userId).collection('players')
          .orderBy('totalScore', 'desc')
          .onSnapshot(
            (snapshot) => {
              const firestorePlayers = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));

              // If Firestore is empty but localStorage has data, migrate it (only once)
              if (firestorePlayers.length === 0 && !hasMigrated) {
                const saved = localStorage.getItem('softballPlayers');
                if (saved) {
                  try {
                    const localPlayers = JSON.parse(saved);
                    if (localPlayers.length > 0) {
                      // Migrate localStorage data to Firestore
                      const batch = db.batch();
                      localPlayers.forEach(player => {
                        const docRef = db.collection('users').doc(userId).collection('players').doc(String(player.id));
                        batch.set(docRef, player);
                      });
                      batch.commit().then(() => {
                        console.log('Migrated localStorage data to Firestore');
                      });
                      setPlayers(localPlayers);
                    }
                  } catch (e) {
                    console.error('Error migrating data:', e);
                  }
                }
                setHasMigrated(true);
              } else if (firestorePlayers.length === 0) {
                // Firestore is empty and we've already migrated - user deleted all players
                setPlayers([]);
                localStorage.removeItem('softballPlayers');
              } else {
                setPlayers(firestorePlayers);
                // Keep localStorage in sync for offline fallback
                localStorage.setItem('softballPlayers', JSON.stringify(firestorePlayers));
                setHasMigrated(true);
              }

              setSyncStatus('synced');
              setIsLoading(false);
            },
            (error) => {
              console.error('Firestore sync error:', error);
              setSyncStatus('error');
              // Fall back to localStorage
              const saved = localStorage.getItem('softballPlayers');
              if (saved) {
                try {
                  setPlayers(JSON.parse(saved));
                } catch (e) {
                  console.error('Error loading saved data:', e);
                }
              }
              setIsLoading(false);
            }
          );

        return () => unsubscribe();
      }, [userId]);

      useEffect(() => {
        const onKey = (e) => {
          if (e.key === 'Escape') {
            if (modal.visible) setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' });
            if (updateModal) setUpdateModal(false);
          }
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [modal.visible, updateModal]);

      const addPlayer = async () => {
        if (currentPlayer.number.trim()) {
          const totalScore = currentPlayer.hitting + currentPlayer.popfly + currentPlayer.fielding + currentPlayer.throwing;
          // Prevent duplicate player numbers
          const numberToAdd = currentPlayer.number.trim();
          const existingPlayer = players.find(p => String(p.number).trim() === numberToAdd);
          if (existingPlayer) {
            setModal({
              visible: true,
              title: 'Duplicate Number',
              message: `Player #${numberToAdd} already exists. Would you like to edit the existing player instead?`,
              onAction: () => {
                startEdit(existingPlayer);
                setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' });
              },
              actionLabel: 'Edit Existing Player'
            });
            return;
          }

          const newPlayer = { ...currentPlayer, id: Date.now(), totalScore };

          // Save to Firestore if authenticated
          if (userId) {
            setSyncStatus('syncing');
            try {
              await db.collection('users').doc(userId).collection('players').doc(String(newPlayer.id)).set(newPlayer);
              setSyncStatus('synced');
            } catch (error) {
              console.error('Error saving player:', error);
              setSyncStatus('error');
              // Still add to local state as fallback
              setPlayers([...players, newPlayer]);
              localStorage.setItem('softballPlayers', JSON.stringify([...players, newPlayer]));
            }
          } else {
            // Offline fallback
            setPlayers([...players, newPlayer]);
            localStorage.setItem('softballPlayers', JSON.stringify([...players, newPlayer]));
          }

          setCurrentPlayer({
            number: '',
            hitting: 5,
            popfly: 5,
            fielding: 5,
            throwing: 5,
            comments: ''
          });
        }
      };

      const startEdit = (player) => {
        setEditingId(player.id);
        setCurrentPlayer({ ...player });
      };

      const saveEdit = async () => {
        const totalScore = currentPlayer.hitting + currentPlayer.popfly + currentPlayer.fielding + currentPlayer.throwing;
        // Prevent duplicate player numbers when saving edits
        const editedNumber = String(currentPlayer.number || '').trim();
        if (!editedNumber) {
          setModal({ visible: true, title: 'Missing Number', message: 'Player number is required.', onAction: null, actionLabel: '' });
          return;
        }

        const existingPlayer = players.find(p => p.id !== editingId && String(p.number).trim() === editedNumber);
        if (existingPlayer) {
          setModal({
            visible: true,
            title: 'Duplicate Number',
            message: `Player #${editedNumber} already exists. Would you like to switch to editing that player instead?`,
            onAction: () => {
              startEdit(existingPlayer);
              setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' });
            },
            actionLabel: 'Switch to That Player'
          });
          return;
        }

        const updatedPlayer = { ...currentPlayer, totalScore };

        // Save to Firestore if authenticated
        if (userId) {
          setSyncStatus('syncing');
          try {
            await db.collection('users').doc(userId).collection('players').doc(String(editingId)).set(updatedPlayer);
            setSyncStatus('synced');
          } catch (error) {
            console.error('Error updating player:', error);
            setSyncStatus('error');
            // Still update local state as fallback
            const updatedPlayers = players.map(p => p.id === editingId ? updatedPlayer : p);
            setPlayers(updatedPlayers);
            localStorage.setItem('softballPlayers', JSON.stringify(updatedPlayers));
          }
        } else {
          // Offline fallback
          const updatedPlayers = players.map(p => p.id === editingId ? updatedPlayer : p);
          setPlayers(updatedPlayers);
          localStorage.setItem('softballPlayers', JSON.stringify(updatedPlayers));
        }

        cancelEdit();
      };

      const cancelEdit = () => {
        setEditingId(null);
        setCurrentPlayer({
          number: '',
          hitting: 5,
          popfly: 5,
          fielding: 5,
          throwing: 5,
          comments: ''
        });
      };

      const deletePlayer = async (id) => {
        // Delete from Firestore if authenticated
        if (userId) {
          setSyncStatus('syncing');
          try {
            await db.collection('users').doc(userId).collection('players').doc(String(id)).delete();
            setSyncStatus('synced');
          } catch (error) {
            console.error('Error deleting player:', error);
            setSyncStatus('error');
            // Still delete from local state as fallback
            const remainingPlayers = players.filter(p => p.id !== id);
            setPlayers(remainingPlayers);
            if (remainingPlayers.length === 0) {
              localStorage.removeItem('softballPlayers');
            } else {
              localStorage.setItem('softballPlayers', JSON.stringify(remainingPlayers));
            }
          }
        } else {
          // Offline fallback
          const remainingPlayers = players.filter(p => p.id !== id);
          setPlayers(remainingPlayers);
          if (remainingPlayers.length === 0) {
            localStorage.removeItem('softballPlayers');
          } else {
            localStorage.setItem('softballPlayers', JSON.stringify(remainingPlayers));
          }
        }
      };

      const exportData = () => {
        if (players.length === 0) {
          alert('No players to export!');
          return;
        }
        
        const headers = ['Player Number', 'Hitting', 'Pop Fly', 'Fielding', 'Throwing', 'Total Score', 'Comments'];
        
        const rows = players.map(player => [
          player.number,
          player.hitting,
          player.popfly || player.bunting || 0,
          player.fielding,
          player.throwing,
          player.totalScore,
          `"${(player.comments || '').replace(/"/g, '""')}"`
        ]);
        
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');
        
        const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'softball-ratings.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const getScoreColor = (score) => {
        if (score >= 32) return 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white';
        if (score >= 24) return 'bg-gradient-to-r from-green-400 to-emerald-500 text-white';
        if (score >= 16) return 'bg-gradient-to-r from-blue-400 to-cyan-500 text-white';
        return 'bg-gradient-to-r from-gray-400 to-slate-500 text-white';
      };

      const getSliderStyle = (value, color) => {
        return {
          background: `linear-gradient(to right, ${color} 0%, ${color} ${value * 10}%, #e5e7eb ${value * 10}%, #e5e7eb 100%)`,
          color: color
        };
      };

      const getSyncStatusDisplay = () => {
        switch (syncStatus) {
          case 'synced':
            return { icon: <Cloud size={14} />, text: 'Synced', color: 'text-green-300' };
          case 'syncing':
            return { icon: <Loader size={14} className="animate-spin" />, text: 'Syncing...', color: 'text-yellow-300' };
          case 'error':
            return { icon: <CloudOff size={14} />, text: 'Sync error', color: 'text-red-300' };
          default:
            return { icon: <CloudOff size={14} />, text: 'Offline', color: 'text-gray-300' };
        }
      };

      const syncDisplay = getSyncStatusDisplay();

      // Show loading screen while initializing
      if (isLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-600 via-emerald-700 to-teal-800 flex items-center justify-center" style={{fontFamily: 'system-ui, -apple-system, sans-serif'}}>
            <div className="text-center">
              <div className="text-6xl mb-4">âš¾</div>
              <Loader size={32} className="animate-spin text-white mx-auto mb-2" />
              <p className="text-white font-bold">Loading...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-600 via-emerald-700 to-teal-800 p-3 sm:p-6" style={{fontFamily: 'system-ui, -apple-system, sans-serif'}}>
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="text-center mb-4">
              <h1 className="text-4xl sm:text-5xl font-black text-white mb-1" style={{textShadow: '3px 3px 0px rgba(0,0,0,0.3)'}}>
                âš¾ RosterRANK
              </h1>
              <p className="text-yellow-300 font-bold text-lg">Rate Your Players</p>
              {/* Sync Status */}
              <div className={`inline-flex items-center gap-1 mt-1 text-xs ${syncDisplay.color}`}>
                {syncDisplay.icon}
                <span>{syncDisplay.text}</span>
              </div>
            </div>

            {/* Form */}
            <div className="bg-white rounded-2xl shadow-2xl p-4 mb-4">
              <input
                type="number"
                inputMode="numeric"
                value={currentPlayer.number}
                onChange={(e) => setCurrentPlayer({...currentPlayer, number: e.target.value.replace(/[^0-9]/g, '')})}
                className="w-full px-4 py-3 mb-3 text-2xl font-bold text-center border-4 border-orange-400 rounded-xl focus:outline-none focus:border-orange-600"
                placeholder="# Player Number"
                min="0"
              />

              {/* Compact Sliders */}
              <div className="space-y-3 mb-3">
                {[
                  {key: 'hitting', label: 'âš¾ Hit', color: '#ef4444'},
                  {key: 'popfly', label: 'ðŸŽ¯ Fly', color: '#3b82f6'},
                  {key: 'fielding', label: 'ðŸ¥Ž Field', color: '#22c55e'},
                  {key: 'throwing', label: 'ðŸ’ª Throw', color: '#a855f7'}
                ].map(({key, label, color}) => (
                  <div key={key} className="flex items-center gap-3">
                    <div className="w-16 text-sm font-bold text-gray-700">{label}</div>
                    <input
                      type="range"
                      min="1"
                      max="10"
                      value={currentPlayer[key]}
                      onChange={(e) => setCurrentPlayer({...currentPlayer, [key]: parseInt(e.target.value)})}
                      className="flex-1 h-3 rounded-lg cursor-pointer"
                      style={getSliderStyle(currentPlayer[key], color)}
                    />
                    <div className="w-12 h-10 text-white font-black text-xl rounded-lg flex items-center justify-center shadow-lg" style={{backgroundColor: color}}>
                      {currentPlayer[key]}
                    </div>
                  </div>
                ))}
              </div>

              <textarea
                value={currentPlayer.comments}
                onChange={(e) => setCurrentPlayer({...currentPlayer, comments: e.target.value})}
                className="w-full px-3 py-2 mb-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 text-sm"
                rows="2"
                placeholder="Notes..."
              />

              {editingId ? (
                <div className="flex gap-2">
                  <button
                    onClick={saveEdit}
                    className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black py-3 rounded-xl shadow-lg active:scale-95 transition"
                  >
                    <Save className="inline mr-1" size={18} />
                    SAVE
                  </button>
                  <button
                    onClick={cancelEdit}
                    className="flex-1 bg-gradient-to-r from-gray-500 to-slate-600 text-white font-black py-3 rounded-xl shadow-lg active:scale-95 transition"
                  >
                    <X className="inline mr-1" size={18} />
                    CANCEL
                  </button>
                </div>
              ) : (
                <button
                  onClick={addPlayer}
                  className="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition text-lg"
                >
                  <Plus className="inline mr-2" size={22} />
                  ADD PLAYER
                </button>
              )}
            </div>

            {/* Roster */}
            {players.length > 0 && (
              <div className="bg-white rounded-2xl shadow-2xl p-4">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-2xl font-black text-gray-800">
                    TEAM <span className="text-orange-600">({players.length})</span>
                  </h2>
                  <button
                    onClick={exportData}
                    className="bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg active:scale-95 transition"
                  >
                    <Download className="inline mr-1" size={16} />
                    EXPORT
                  </button>
                </div>

                <div className="space-y-2">
                  {players.sort((a, b) => b.totalScore - a.totalScore).map((player, index) => (
                    <div key={player.id} className="border-4 border-gray-200 rounded-xl p-3 bg-gradient-to-r from-gray-50 to-white">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 bg-gray-800 text-yellow-400 font-black rounded-full flex items-center justify-center text-sm">
                            {index + 1}
                          </div>
                          <div className="text-2xl font-black text-gray-800">
                            #{player.number}
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className={`${getScoreColor(player.totalScore)} px-4 py-2 rounded-lg font-black text-xl shadow-lg`}>
                            {player.totalScore}
                          </div>
                          <button
                            onClick={() => startEdit(player)}
                            className="text-blue-600 active:scale-90 transition"
                          >
                            <Edit2 size={20} />
                          </button>
                          <button
                            onClick={() => deletePlayer(player.id)}
                            className="text-red-600 active:scale-90 transition"
                          >
                            <Trash2 size={20} />
                          </button>
                        </div>
                      </div>

                      <div className="flex gap-2 text-xs font-bold">
                        <div className="flex-1 bg-red-100 rounded px-2 py-1">âš¾ {player.hitting}</div>
                        <div className="flex-1 bg-blue-100 rounded px-2 py-1">ðŸŽ¯ {player.popfly}</div>
                        <div className="flex-1 bg-green-100 rounded px-2 py-1">ðŸ¥Ž {player.fielding}</div>
                        <div className="flex-1 bg-purple-100 rounded px-2 py-1">ðŸ’ª {player.throwing}</div>
                      </div>

                      {player.comments && (
                        <div className="mt-2 text-xs text-gray-600 italic bg-yellow-50 rounded p-2">
                          {player.comments}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {players.length === 0 && (
              <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                <div className="text-6xl mb-3">âš¾</div>
                <p className="text-gray-500 font-bold text-lg">Add your first player!</p>
              </div>
            )}

            {/* Version Footer */}
            {appVersion && (
              <div className="text-center mt-4 mb-2">
                <button
                  onClick={() => setUpdateModal(true)}
                  className="text-white/70 hover:text-white text-xs font-bold transition"
                >
                  v{appVersion} - What's New?
                </button>
              </div>
            )}
          </div>

          {modal.visible && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fadeIn"
              style={{animation: 'fadeIn 0.2s ease-out'}}
              onClick={() => setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' })}
            >
              <style>{`
                @keyframes fadeIn {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                @keyframes slideUp {
                  from {
                    opacity: 0;
                    transform: translateY(20px) scale(0.95);
                  }
                  to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                  }
                }
                @keyframes pulse {
                  0%, 100% { transform: scale(1); }
                  50% { transform: scale(1.05); }
                }
                @keyframes spin {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
              `}</style>
              <div
                className="bg-white rounded-3xl p-6 max-w-sm w-full mx-4 shadow-2xl text-center"
                style={{animation: 'slideUp 0.3s ease-out'}}
                onClick={(e) => e.stopPropagation()}
                role="dialog"
                aria-modal="true"
                aria-labelledby="modal-title"
              >
                <div className="mb-4">
                  <div
                    className={`w-20 h-20 mx-auto rounded-full flex items-center justify-center shadow-lg ${
                      modal.onAction
                        ? 'bg-gradient-to-br from-blue-500 to-cyan-600'
                        : 'bg-gradient-to-br from-red-500 to-orange-600'
                    }`}
                    style={{animation: 'pulse 2s ease-in-out infinite'}}
                  >
                    {modal.onAction ? (
                      <Edit2 size={48} className="text-white" strokeWidth={3} />
                    ) : (
                      <AlertCircle size={48} className="text-white" strokeWidth={3} />
                    )}
                  </div>
                </div>
                <div id="modal-title" className="text-3xl font-black text-gray-900 mb-3">{modal.title}</div>
                <div className="text-base text-gray-700 mb-6 leading-relaxed">{modal.message}</div>
                {modal.onAction ? (
                  <div className="space-y-2">
                    <button
                      onClick={modal.onAction}
                      className="w-full bg-gradient-to-r from-blue-500 to-cyan-600 text-white font-black py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-lg"
                    >
                      <Edit2 className="inline mr-2" size={20} />
                      {modal.actionLabel}
                    </button>
                    <button
                      onClick={() => setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' })}
                      className="w-full bg-gradient-to-r from-gray-500 to-slate-600 text-white font-black py-3 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all"
                    >
                      <X className="inline mr-1" size={18} />
                      Cancel
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setModal({ visible: false, title: '', message: '', onAction: null, actionLabel: '' })}
                    className="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white font-black py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-lg"
                  >
                    GOT IT
                  </button>
                )}
              </div>
            </div>
          )}

          {updateModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
              style={{animation: 'fadeIn 0.2s ease-out'}}
            >
              <div
                className="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-3xl p-6 max-w-md w-full mx-4 shadow-2xl text-center border-4 border-emerald-400"
                style={{animation: 'slideUp 0.3s ease-out'}}
                onClick={(e) => e.stopPropagation()}
                role="dialog"
                aria-modal="true"
              >
                <div className="mb-4">
                  <div
                    className="w-24 h-24 mx-auto bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center shadow-lg"
                    style={{animation: 'spin 3s linear infinite'}}
                  >
                    <Sparkles size={52} className="text-yellow-300" strokeWidth={3} />
                  </div>
                </div>
                <div className="text-4xl font-black text-gray-900 mb-3">ðŸŽ‰ Update Available!</div>
                <div className="text-lg font-bold text-emerald-700 mb-2">RosterRank v{appVersion}</div>
                {currentChangelog.date && (
                  <div className="text-xs text-gray-500 mb-4">{currentChangelog.date}</div>
                )}
                <div className="bg-white rounded-xl p-4 mb-5 text-left shadow-inner">
                  <div className="text-sm font-bold text-gray-800 mb-2">What's New:</div>
                  <ul className="text-sm text-gray-700 space-y-1">
                    {currentChangelog.changes.map((change, index) => (
                      <li key={index} className="flex items-start gap-2">
                        <span className="text-emerald-600 font-bold">â€¢</span>
                        <span>{change}</span>
                      </li>
                    ))}
                  </ul>
                </div>
                <button
                  onClick={() => window.location.reload()}
                  className="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-lg mb-2"
                >
                  âœ¨ REFRESH NOW
                </button>
                <button
                  onClick={() => setUpdateModal(false)}
                  className="w-full text-gray-600 font-bold py-2 rounded-lg hover:bg-white/50 transition text-sm"
                >
                  Maybe Later
                </button>
              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.render(<SoftballPlayerRater />, document.getElementById('root'));

    // PWA Service Worker Registration and Update Checking
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/rosterrank/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
            
            // Check for updates every 30 seconds for faster deployment
            setInterval(() => {
              registration.update();
            }, 30000);
            
            // Also check on page visibility change (when user returns to tab)
            document.addEventListener('visibilitychange', () => {
              if (!document.hidden) {
                registration.update();
              }
            });

            // Listen for new service worker waiting
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker is ready but waiting
                  console.log('New version available, showing update notification');
                  showUpdateNotification();
                }
              });
            });

            // Listen for controller change (indicates new version activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              console.log('Service worker updated');
            });
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      });

      // Handle update available
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });

      // Listen for messages from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
          showUpdateNotification();
        }
      });
    }

    // Show update notification modal
    function showUpdateNotification() {
      // Call the React function to show the modal
      if (window.showUpdateModal) {
        window.showUpdateModal();
      }
    }
  </script>
</body>
</html>